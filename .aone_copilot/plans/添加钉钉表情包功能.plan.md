### 添加钉钉表情包功能 ###
为 nanobot 添加表情包发送能力，让 bot 能根据情绪从本地表情包库中选择合适的图片发送到钉钉聊天中。


## 整体思路

分三层实现：**表情包存储** + **Agent 工具** + **钉钉发送支持**

Bot 通过一个新的 `sticker` 工具，从表情包索引中选择合适的表情包名称，工具返回图片 URL，然后通过钉钉的 `sampleImageMsg` 消息类型发送图片。

---

### 步骤 1：创建表情包存储目录和索引文件

**位置**：`/Users/xiongmengjun/Documents/program/nanobot/workspace/stickers/`（不进 git）

- 创建 `/Users/xiongmengjun/Documents/program/nanobot/workspace/stickers/` 目录
- 创建索引文件 `/Users/xiongmengjun/Documents/program/nanobot/workspace/stickers/index.json`，格式如下：

```json
{
  "开心": "https://xxx.com/happy.gif",
  "无语": "https://xxx.com/speechless.gif",
  "加油": "https://xxx.com/fighting.gif",
  "委屈": "https://xxx.com/sad.gif"
}
```

- 表情包图片需要有**公网可访问的 URL**（可以用图床、OSS、或者钉钉自带的媒体上传）
- 用户自行准备图片并上传到图床，然后在 `index.json` 中维护名称到 URL 的映射

---

### 步骤 2：新增 `StickerTool`（Agent 工具）

**新建文件**：`nanobot/agent/tools/sticker.py`

- 创建 `StickerTool` 类，继承 `Tool` 基类
- 初始化时从 workspace 的 `stickers/index.json` 加载表情包索引
- 工具参数：`name`（表情包名称）
- `execute()` 逻辑：
  1. 根据 `name` 查找对应的图片 URL
  2. 通过 `send_callback` 发送一条 `OutboundMessage`，在 `metadata` 中标记 `msg_type: "image"` 和 `photo_url: "xxx"`
  3. 返回 "表情包已发送" 或 "未找到该表情包"
- 工具的 `description` 中列出所有可用的表情包名称，让 LLM 知道有哪些可选

---

### 步骤 3：注册 `StickerTool` 到 AgentLoop

**修改文件**：`nanobot/agent/loop.py`

- 导入 `StickerTool`
- 在 `_register_default_tools()` 中注册 `StickerTool`，传入 workspace 路径和 `send_callback`
- 设置 context 时同步设置 `StickerTool` 的 channel 和 chat_id

---

### 步骤 4：钉钉 channel 支持发送图片消息

**修改文件**：`nanobot/channels/dingtalk.py`

- 修改 `_send_private_message()` 和 `_send_group_message()`：
  - 检查 `msg.metadata` 中是否有 `msg_type == "image"`
  - 如果是图片消息，`msgKey` 使用 `"sampleImageMsg"`，`msgParam` 使用 `{"photoURL": metadata["photo_url"]}`
  - 否则保持原有的 `sampleMarkdown` 逻辑不变

---

### 步骤 5：在 SOUL.md 中引导 bot 使用表情包

**修改文件**：`workspace/SOUL.md`

- 在人设中加一段指引，告诉 bot：
  - 在合适的情绪场景下使用 `sticker` 工具发送表情包
  - 表情包是对文字回复的补充，不要替代文字回复
  - 不要每条消息都发表情包，适度使用

---



### 文件变更总结

| 文件 | 操作 |
|------|------|
| `nanobot/agent/tools/sticker.py` | 新建 |
| `nanobot/agent/loop.py` | 修改（注册 StickerTool） |
| `nanobot/channels/dingtalk.py` | 修改（支持 sampleImageMsg） |
| `workspace/SOUL.md` | 修改（加表情包使用引导） |
| `.gitignore` | 修改（忽略 stickers 目录） |
| `~/.nanobot/workspace/stickers/index.json` | 新建（用户维护） |


updateAtTime: 2026/2/13 14:44:01

planId: 261c52ef-a08f-48dd-9eb8-ce05920658f4